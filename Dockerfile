#####################################################
# 1) 베이스 이미지: Python 3.9 slim 사용
#####################################################
FROM python:3.9-slim

#####################################################
# 2) 환경 변수
#####################################################
ENV PYTHONUNBUFFERED=1
ENV DEBIAN_FRONTEND=noninteractive

#####################################################
# 3) 시스템 패키지 설치
#####################################################
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
       build-essential \
       unzip \
       git \
       libffi-dev \
    && rm -rf /var/lib/apt/lists/*

#####################################################
# 4) 작업 디렉터리 설정
#####################################################
WORKDIR /app

#####################################################
# 5) ember 피쳐 추출기 설치
#    (컨테이너 안에 EMBER 소스코드가 /app/ember 에 있다고 가정)
#####################################################
COPY ember /app/ember
RUN pip install --upgrade pip \
    && pip install --no-cache-dir /app/ember

#####################################################
# 6) NumPy & LightGBM 고정 버전 설치
#####################################################
RUN pip install --no-cache-dir \
        numpy==1.23.5 \
        lightgbm==3.3.2

#####################################################
# 7) 나머지 Python 패키지 설치
#    (requirements.txt 에 scikit-learn==0.24.2 등 고정 명시 필요)
#####################################################
COPY requirements.txt /app/requirements.txt
RUN pip install --no-cache-dir -r /app/requirements.txt

#####################################################
# 8) 애플리케이션 코드 복사
#    - app.py, templates/index.html, model/malware_model.pkl 등
#####################################################
COPY . /app

#####################################################
# 9) Flask 외부 노출 포트 (5000)
#####################################################
EXPOSE 5000

#####################################################
# 10) 컨테이너 시작 명령
#####################################################
CMD ["python", "app.py"]